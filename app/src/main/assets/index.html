<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sanskrit Flashcards</title>
    <style>
        :root {
            --body-background: #333a45;
            --card-front-background: #e9f5fe; /* Light blue for front */
            --card-back-background: #fffada;  /* Light yellow for back */
            --card-border: #cce7f8;
            --text-color: #333;
            --stats-text-color: #f0f0f0;
            --accent-color: #007bff;
            --correct-color-value: #28a745;
            --wrong-color-value: #dc3545;
            --button-text-color: #fff;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--body-background);
            color: var(--stats-text-color);
            padding: 10px;
            overflow: hidden;
        }
        .app-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stats-bar {
            width: 100%;
            padding: 10px 0;
            text-align: center;
            font-size: 1.1em;
            color: var(--stats-text-color);
            margin-bottom: 20px;
            white-space: nowrap;
            overflow-x: auto;
        }
        .stats-bar span { margin: 0 5px; }
        .stat-value { font-weight: bold; }
        .stat-correct-value { color: var(--correct-color-value); }
        .stat-wrong-value { color: var(--wrong-color-value); }
        .stat-completion-value { color: var(--accent-color); }

        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
        }
        .flashcard {
            width: 90%;
            max-width: 400px;
            min-height: 280px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s; /* This is the key transition for the flip */
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 12px;
            background-color: var(--card-front-background);
            border: 1px solid var(--card-border);
            text-align: center;
            color: var(--text-color);
        }
        .card-front {}
        .card-back {
            background-color: var(--card-back-background);
            transform: rotateY(180deg);
        }
        .sanskrit-word {
            font-size: 2.6em; margin-bottom: 10px; word-break: break-word;
        }
        .pronunciation {
            font-size: 1.0em; line-height: 1.4; margin-bottom: 5px;
        }
        .pronunciation:last-of-type { margin-bottom: 10px; }
        .english-meaning {
            font-size: 1.8em; word-break: break-word;
        }
        .card-counter {
            font-size: 0.85em; color: #666; position: absolute; bottom: 10px; left: 0; right: 0; text-align: center;
        }
        .controls {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; margin-top: 25px; flex-shrink: 0;
        }
        .controls button {
            padding: 10px 15px; font-size: 1em; background-color: var(--accent-color);
            color: var(--button-text-color); border: none; border-radius: 8px; cursor: pointer;
            min-width: 90px; text-align: center; transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .controls button.reset-button { background-color: #6c757d; }
        .controls button.reset-button:hover { background-color: #5a6268; }
        .controls button:disabled {
            background-color: #777; box-shadow: none; cursor: not-allowed;
        }
        .swipe-feedback {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            font-size: 5em; color: white; padding: 20px; border-radius: 50%;
            opacity: 0; transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none; z-index: 10;
        }
        .swipe-feedback.show { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
        .swipe-feedback.correct { background-color: rgba(40, 167, 69, 0.75); }
        .swipe-feedback.wrong { background-color: rgba(220, 53, 69, 0.75); }
        #loading-indicator {}
    </style>
</head>
<body>
<div class="app-container">
    <div class="stats-bar">
        <span>Correct: <span id="correct-count" class="stat-value stat-correct-value">0</span></span>
        <span>Wrong: <span id="wrong-count" class="stat-value stat-wrong-value">0</span></span>
        <span>Completion: <span id="completion-percentage" class="stat-value stat-completion-value">0%</span></span>
    </div>
    <div id="loading-indicator">Loading words...</div>
    <div class="flashcard-container" style="display: none;">
        <div class="flashcard" id="flashcard">
            <div class="card-face card-front">
                <div id="sanskrit-word" class="sanskrit-word"></div>
                <div id="phonetic-1" class="pronunciation"></div>
                <div id="phonetic-2" class="pronunciation"></div>
                <div id="card-counter-front" class="card-counter"></div>
            </div>
            <div class="card-face card-back">
                <div id="english-meaning" class="english-meaning"></div>
                <div id="card-counter-back" class="card-counter"></div>
            </div>
        </div>
        <div id="swipe-feedback-overlay" class="swipe-feedback"></div>
    </div>
    <div class="controls">
        <button id="prev-button">Prev</button>
        <button id="reset-button" class="reset-button">Reset</button>
        <button id="next-button">Next</button>
    </div>
</div>

<script>
    let allWords = [];
    let currentDeck = [];
    let currentIndex = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let uniqueWordsAttemptedInSession = new Set();

    const flashcardElement = document.getElementById('flashcard');
    const sanskritWordEl = document.getElementById('sanskrit-word');
    const phonetic1El = document.getElementById('phonetic-1');
    const phonetic2El = document.getElementById('phonetic-2');
    const englishMeaningEl = document.getElementById('english-meaning');
    const cardCounterFrontEl = document.getElementById('card-counter-front');
    const cardCounterBackEl = document.getElementById('card-counter-back');
    const prevButton = document.getElementById('prev-button');
    const nextButton = document.getElementById('next-button');
    const resetButton = document.getElementById('reset-button');
    const correctCountValEl = document.getElementById('correct-count');
    const wrongCountValEl = document.getElementById('wrong-count');
    const completionPercentageValEl = document.getElementById('completion-percentage');
    const loadingIndicator = document.getElementById('loading-indicator');
    const flashcardContainer = document.querySelector('.flashcard-container');
    const swipeFeedbackOverlay = document.getElementById('swipe-feedback-overlay');

    console.log("SanskritFlashcards JS: Script start.");

    function initializeApp() {
        console.log("JS: initializeApp called");
        loadingIndicator.style.display = 'block';
        flashcardContainer.style.display = 'none';
        correctCountValEl.textContent = '0';
        wrongCountValEl.textContent = '0';
        completionPercentageValEl.textContent = '0%';

        if (typeof AndroidInterface !== 'undefined' && typeof AndroidInterface.getSanskritWords === 'function') {
            try {
                const rawData = AndroidInterface.getSanskritWords();
                console.log("JS: Raw data received, length:", rawData ? rawData.length : 'null');
                if (!rawData || rawData.trim() === "") {
                    loadingIndicator.textContent = "Error: Empty data from Android."; return;
                }
                allWords = parseData(rawData);
                console.log("JS: Parsed ${allWords.length} words.");
                if (allWords.length === 0) {
                    loadingIndicator.textContent = "No words found after parsing."; return;
                }
                resetStatsAndDeck();
                updateDisplay();
                loadingIndicator.style.display = 'none';
            } catch (e) {
                loadingIndicator.textContent = "Init Error. Check console."; console.error("JS Init Error:", e);
                flashcardElement.innerHTML = `<div class="card-face card-front" style="color:red; font-size:1em;">Error: ${e.message}.</div>`;
                flashcardContainer.style.display = 'flex';
            }
        } else {
            loadingIndicator.textContent = "Error: AndroidInterface missing."; console.error("JS: AndroidInterface missing.");
            flashcardElement.innerHTML = '<div class="card-face card-front" style="color:red; font-size:1em;">Error: AndroidInterface not found.</div>';
            flashcardContainer.style.display = 'flex';
        }
        setupEventListeners();
    }

    function parseData(dataString) {
        const processedDataString = dataString.replace(/\\n/g, '\n');
        const linesArray = processedDataString.split(/\r?\n/);
        let malformedLinesSkipped = 0;
        let parsedWords = linesArray.map(line => line.trim())
            .filter(line => line.length > 0 && !line.startsWith("#"))
            .map((line, index) => {
                const parts = line.split('\t');
                let sanskrit = "", phonetic = "", iast = "", english = "";
                let col = 0;
                const getNextPart = () => {
                    while (col < parts.length && parts[col].trim() === "") col++;
                    return col < parts.length ? parts[col++].trim() : "";
                };
                sanskrit = getNextPart(); phonetic = getNextPart(); iast = getNextPart(); english = getNextPart();
                if (sanskrit && english) {
                    return { id: index, sanskrit, phonetic, iast, english, status: 'unseen' };
                } else {
                    malformedLinesSkipped++; return null;
                }
            }).filter(word => word !== null);
        return parsedWords;
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function resetStatsAndDeck() {
        console.log("JS: resetStatsAndDeck called");
        correctCount = 0; wrongCount = 0; uniqueWordsAttemptedInSession.clear();
        currentDeck = [...allWords];
        shuffleArray(currentDeck);
        currentIndex = 0;
        if (currentDeck.length > 0) currentDeck.forEach(word => word.status = 'unseen');
    }

    function updateDisplay() {
        console.log("JS: updateDisplay. Idx:", currentIndex, "Deck:", currentDeck.length);

        // ***** STRONGER FIX (Option B) *****
        if (flashcardElement.classList.contains('is-flipped')) {
            console.log("JS: Card was flipped, INSTANTLY removing 'is-flipped'.");
            flashcardElement.style.transition = 'none'; // Temporarily disable animation
            flashcardElement.classList.remove('is-flipped');
            void flashcardElement.offsetHeight; // Force browser reflow/repaint
            flashcardElement.style.transition = ''; // Re-enable animation (restores from CSS)
        }
        // ***** END STRONGER FIX *****

        if (currentDeck.length === 0 || currentIndex < 0 || currentIndex >= currentDeck.length) {
            console.log("JS: No card to display or index OOB.");
            flashcardContainer.style.display = 'none';
            sanskritWordEl.textContent = ''; phonetic1El.textContent = ''; phonetic2El.textContent = '';
            englishMeaningEl.textContent = ''; cardCounterFrontEl.textContent = ''; cardCounterBackEl.textContent = '';
            prevButton.disabled = true; nextButton.disabled = true;
            resetButton.disabled = allWords.length === 0;
            if (allWords.length > 0) {
                flashcardElement.innerHTML = `<div class="card-face card-front" style="display:flex; align-items:center; justify-content:center; font-size:1.2em;">Deck complete or no words.</div>`;
                flashcardContainer.style.display = 'flex';
            }
            updateStats(); return;
        }
        flashcardContainer.style.display = 'flex';
        const word = currentDeck[currentIndex];
        console.log("JS: Displaying word:", word.sanskrit);
        sanskritWordEl.textContent = word.sanskrit;
        phonetic1El.textContent = word.phonetic || '';
        phonetic2El.textContent = word.iast || '';
        englishMeaningEl.textContent = word.english;
        const cardNumTxt = `${currentIndex + 1} / ${currentDeck.length}`;
        cardCounterFrontEl.textContent = cardNumTxt; cardCounterBackEl.textContent = cardNumTxt;
        phonetic1El.style.display = word.phonetic ? 'block' : 'none';
        phonetic2El.style.display = word.iast ? 'block' : 'none';
        prevButton.disabled = currentIndex === 0;
        nextButton.disabled = currentIndex === currentDeck.length - 1;
        resetButton.disabled = false;
        updateStats();
    }

    function updateStats() {
        correctCountValEl.textContent = correctCount;
        wrongCountValEl.textContent = wrongCount;
        const totalWords = allWords.length;
        if (totalWords > 0) {
            const perc = Math.round((uniqueWordsAttemptedInSession.size / totalWords) * 100);
            completionPercentageValEl.textContent = `${perc}%`;
        } else {
            completionPercentageValEl.textContent = '0%';
        }
    }

    function showNextCard() {
        if (currentIndex < currentDeck.length - 1) { currentIndex++; updateDisplay(); }
    }
    function showPrevCard() {
        if (currentIndex > 0) { currentIndex--; updateDisplay(); }
    }

    function markCard(isCorrect) {
        if (currentIndex >= 0 && currentIndex < currentDeck.length) {
            const word = currentDeck[currentIndex];
            if (!uniqueWordsAttemptedInSession.has(word.id)) {
                if (isCorrect) { correctCount++; word.status = 'correct'; }
                else { wrongCount++; word.status = 'wrong'; }
                uniqueWordsAttemptedInSession.add(word.id);
            }
            updateStats();
            showSwipeFeedback(isCorrect);
            if (typeof AndroidInterface !== 'undefined' && AndroidInterface.performHapticFeedback) {
                AndroidInterface.performHapticFeedback();
            }
            setTimeout(() => {
                if (currentIndex === currentDeck.length - 1) updateDisplay(); else showNextCard();
            }, 800);
        }
    }

    function showSwipeFeedback(isCorrect) {
        swipeFeedbackOverlay.innerHTML = isCorrect ? '&#10004;' : '&#10008;';
        swipeFeedbackOverlay.className = 'swipe-feedback';
        swipeFeedbackOverlay.classList.add(isCorrect ? 'correct' : 'wrong', 'show');
        setTimeout(() => { swipeFeedbackOverlay.classList.remove('show'); }, 600);
    }

    function setupEventListeners() {
        console.log("JS: setupEventListeners called");
        flashcardElement.addEventListener('click', () => {
            flashcardElement.classList.toggle('is-flipped');
            console.log("JS: Card clicked. Flipped:", flashcardElement.classList.contains('is-flipped'));
        });
        nextButton.addEventListener('click', showNextCard);
        prevButton.addEventListener('click', showPrevCard);
        resetButton.addEventListener('click', () => {
            console.log("JS: Reset button clicked");
            if (typeof AndroidInterface !== 'undefined' && AndroidInterface.performHapticFeedback) {
                AndroidInterface.performHapticFeedback();
            }
            resetStatsAndDeck(); updateDisplay();
            flashcardContainer.style.display = currentDeck.length > 0 ? 'flex' : 'none';
        });

        let touchstartX = 0, touchendX = 0, touchstartY = 0, touchendY = 0;
        const swipeThreshold = 50, swipeVerticalThreshold = 70;

        flashcardContainer.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX; touchstartY = e.changedTouches[0].screenY;
        }, { passive: true });
        flashcardContainer.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX; touchendY = e.changedTouches[0].screenY;
            handleSwipeGesture();
        }, { passive: true });

        function handleSwipeGesture() {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;
            if (Math.abs(deltaY) > swipeVerticalThreshold) return;

            if (Math.abs(deltaX) > swipeThreshold) {
                if (!flashcardElement.classList.contains('is-flipped')) {
                    console.log("JS: Swipe on front. Flipping.");
                    flashcardElement.classList.add('is-flipped'); return;
                }
                // SWIPE DIRECTION CORRECTED
                if (deltaX < 0) { // Swiped Left (finger moved R to L)
                    console.log("JS: Swiped left on back (Mark WRONG).");
                    markCard(false); // Mark as WRONG
                } else { // Swiped Right (finger moved L to R)
                    console.log("JS: Swiped right on back (Mark CORRECT).");
                    markCard(true); // Mark as CORRECT
                }
            }
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
</script>
</body>
</html>
